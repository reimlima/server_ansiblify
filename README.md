# Server Ansiblify

[![Bash](https://img.shields.io/badge/bash-5.0%2B-brightgreen.svg)](https://www.gnu.org/software/bash/) [![ShellCheck](https://img.shields.io/badge/shellcheck-passing-brightgreen.svg)](https://www.shellcheck.net/)

A Bash script to automatically generate a complete, portable Ansible playbook that captures the current state of your server. This allows you to easily replicate your server's configuration, users, packages, services, dotfiles, and more on any other machine.

## Features

- **Full System Export:**
  - System configuration files from `/etc/` (including cron, snmp, rsync, motd, ntp, and more)
  - Custom and enabled systemd unit files (including enabled/disabled state)
  - All user dotfiles (excluding `.ssh`) for each user
  - All SSH keys and configs for each user
  - All custom scripts from `/usr/local/bin/`
  - All installed packages (APT, pip, npm)
  - Docker Compose files
  - System-wide and user shell completion files
- **Automatic Playbook Generation:**
  - Generates a complete Ansible playbook structure in the `server_config` folder
  - All playbooks are generated by the script—**do not manually edit files in `server_config`**
  - All roles present in the export are automatically included in the main playbook (`site.yml`)
- **Idempotent and Portable:**
  - The generated playbook can be copied and applied to any compatible server to reproduce your setup
- **ShellCheck Clean:**
  - The script passes ShellCheck with no errors or warnings

## Usage

1. **Run the script on your source server:**
   ```sh
   ./server_ansiblify.sh --all
   ```
   This will export all relevant data and generate the playbook in the `server_config` directory.

2. **(Optional) Test the generated playbook locally:**
   ```sh
   ./server_ansiblify.sh --dry-run
   ```
   This will run syntax and lint checks on the generated playbook.

3. **Copy the `server_config` folder to your target server.**

4. **Apply the playbook on the target server:**
   ```sh
   cd server_config
   ansible-playbook -i inventory/hosts site.yml
   ```

### Allowed Parameters

| Parameter    | Description                           | Mandatory | Example           |
|-------------|---------------------------------------|-----------|--------------------|
| `--all`     | Generate complete playbook            | No        | `--all`            |
| `--dry-run` | Test playbook without making changes  | No        | `--dry-run`        |
| `--vm`      | Process virtual machine configuration | No        | `--vm`             |
| `--system`  | Process system configuration          | No        | `--system`         |
| `--docker`  | Process Docker configuration          | No        | `--docker`         |
| `--ssh`     | Process SSH configuration             | No        | `--ssh`            |
| `--users`   | Process user accounts                 | No        | `--users`          |
| `--paths`   | Process custom paths                  | No        | `--paths`          |
| `--services`| Process system services               | No        | `--services`       |
| `--packages`| Process installed packages            | No        | `--packages`       |
| `--commands`| Process custom commands               | No        | `--commands`       |


## What Gets Exported

- `/etc/hosts`, `/etc/fstab`, `/etc/cron*`, `/etc/snmp/`, `/etc/rsyncd.conf`, `/etc/rsyncd.secrets`, `/etc/motd`, `/etc/update-motd.d/`, `/etc/ntp.conf`, `/etc/ntp/`, and more
- All custom systemd unit files and their enabled/disabled state
- All user dotfiles (excluding `.ssh`)
- All SSH keys/configs for each user
- All scripts from `/usr/local/bin/`
- Lists of installed APT, pip, and npm packages
- Docker Compose files (if present)
- Bash and shell completion files from `/etc/bash_completion.d/` and `/usr/share/bash-completion/completions/`

## How It Works

- The script first exports all relevant files, configs, and lists from your server into the `server_config/roles/*/files/` directories.
- It then generates Ansible playbooks for each role, which copy these files to the correct locations on the target server.
- The main playbook (`site.yml`) is automatically updated to include all roles found in the export.
- All playbook logic is generated by the script—**do not manually edit files in `server_config`**.

## Customization

- You can selectively export only certain modules by passing their names as arguments (see `./server_ansiblify.sh --help`).
- To add more files or directories to export, update the script's export functions as needed.

## Usage Example

### Generate Playbook
```bash
sudo bash server_ansiblify.sh --all
Processing module: vm
Processing module: system
Processing module: commands
Processing module: users
Processing module: ssh
Processing module: docker
Processing module: packages
Processing module: services
Processing module: paths
server_ansiblify.sh: line 995: export_paths: command not found
Ansible playbook structure generated in server_config/
To test the playbook without making changes, run:
  server_ansiblify.sh --dry-run
```

### Test Playbook (Dry Run)
```bash
bash server_ansiblify.sh --dry-run
Testing existing configuration in server_config
Running dry-run tests...
Running playbook tests...
[...]
✅ All tests passed successfully!
```

## Script Output structure

```
server_config/
├── ansible.cfg
├── group_vars
├── inventory
├── requirements.yml
├── requirements.yml
├── site.yml
└── roles
    ├── commands
    │   ├── defaults
    │   ├── files
    │   ├── handlers
    │   ├── meta
    │   ├── tasks
    │   ├── templates
    │   └── vars
    ├── docker
    │   ├── defaults
    │   ├── files
    │   ├── handlers
    │   ├── meta
    │   ├── tasks
    │   ├── templates
    │   └── vars
    ├── packages
    │   ├── defaults
    │   ├── files
    │   ├── handlers
    │   ├── meta
    │   ├── tasks
    │   ├── templates
    │   └── vars
    ├── services
    │   ├── files
    │   │   └── systemd
    │   │       └── multi-user.target.wants
    │   └── tasks
    ├── ssh
    │   ├── defaults
    │   ├── files
    │   │   ├── user1
    │   │   └── user2
    │   ├── handlers
    │   ├── meta
    │   ├── tasks
    │   ├── templates
    │   └── vars
    ├── system
    │   └── files
    │       ├── cron
    │       │   ├── cron.d
    │       │   ├── cron.daily
    │       │   ├── cron.hourly
    │       │   ├── cron.monthly
    │       │   └── cron.weekly
    │       ├── rsync
    │       └── snmp
    │           └── snmpd.conf.d
    ├── users
    │   ├── defaults
    │   ├── files
    │   ├── handlers
    │   ├── meta
    │   ├── tasks
    │   ├── templates
    │   └── vars
    └── vm
        ├── defaults
        ├── files
        ├── handlers
        ├── meta
        ├── tasks
        ├── templates
        └── vars
```

## Run Playbook

Here's how to run the generated playbook
```sh
ansible-playbook -i server_config/inventory/hosts server_config/site.yml
```
> :warning: Make shure the inventory file is pointing toi the right server

## Requirements

- Bash
- Ansible and ansible-lint (for testing/dry-run)
- Python 3 (for YAML validation)

## Author

- [reimlima](https://github.com/reimlima)

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.